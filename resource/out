#!/bin/bash
set -e

export directory=$1

json_input=$(cat)  # Read JSON input from stdin
# {
#     "source": {
#       "bucket_name": "mybucket",
#       "object_name": "myobject",
#       "debug": true,          
#     },
#    "params": {
#       "src": "path/to/my_local_file.txt"
#     }
# }

export bucket_name=$(echo $json_input | jq -r .source.bucket_name )
export object_path=$(echo $json_input | jq -r .source.object_path )
export debug=$(echo $json_input | jq -r .source.debug )
export src=$(echo $json_input | jq -r .params.src )


if [ "$debug" = true ] ; then
    >&2 echo "cp \"$directory/$src\" \"gs://${bucket_name}/${object_path}\""
fi

gcloud storage cp "$directory/$src" "gs://${bucket_name}/${object_path}"  


gcloud storage objects describe "gs://${bucket_name}/${object_path}" > object_metadata.yml

current_version=$( | yq .generation)
creation_time=$(cat object_metadata.yml | yq .creation_time)
update_time=$(cat object_metadata.yml | yq .update_time)
md5_hash=$(cat object_metadata.yml | yq .md5_hash)
metageneration=$(cat object_metadata.yml | yq .metageneration)
storage_url=$(cat object_metadata.yml | yq .storage_url)
size=$(cat object_metadata.yml | yq .size)

# {
#   "version": { "ref": "61cebf" },
#   "metadata": [
#     { "name": "commit", "value": "61cebf" },
#     { "name": "author", "value": "Mick Foley" }
#   ]
# }

output_string="{
  \"version\": { \"ref\": \"${current_version}\" },
  \"metadata\": [
    { \"name\": \"creation_time\", \"value\": \"${creation_time}\"}, \
    { \"name\": \"update_time\", \"value\": \"${update_time}\"}, \
    { \"name\": \"md5_hash\", \"value\": \"${md5_hash}\"}, \
    { \"name\": \"metageneration\", \"value\": \"${metageneration}\"}, \
    { \"name\": \"storage_url\", \"value\": \"${storage_url}\"}, \
    { \"name\": \"size\", \"value\": \"${size}\"} \
  ]
}"

if [ "$debug" = true ] ; then
    >&2 echo $output_string
fi
echo $output_string